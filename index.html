<html>
    <head>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
        <style>
            body {
                background-color: black;
                color: white;
                padding: 10px;
            }
            pre {
                font-size: 32px;
                font-family: "Roboto Mono", Courier;
            }
        </style>
    </head>
    <body>
        <div id="content"></div>
        <script>

const F = 3;
const TIMEFRAME = 24;

async function getData() {
    var data = await fetch("https://dl.dropboxusercontent.com/s/4xsatr8ujknxony/baby.log");
    var logs = (await data.text()).split('\n').reverse().filter(l => !!l.trim().length);
    var total24h = 0;
    var total24hLimit = (new Date()).getTime() - TIMEFRAME * 60 * 60 * 1000;

    var total5h = 0;
    var total5hLimit = (new Date()).getTime() - 5 * 60 * 60 * 1000;

    var lastTimestamp = 0;
    var totalFeedingDiffs = 0;
    var totalFeedings = 0;

    var breastD = 0;
    var bottleD = 0;
    var breastA = 0;
    var bottleA = 0;
    var display = logs.map((log) => {
        var d = parser(log);
        var t = d['type'] === 'bottle' ? 'üçº' : 'ü§±';
        var time = parseInt(d['timestamp']);
        var duration = parseInt(d.duration);
        var datetime = new Date();
        datetime.setTime(time);

        var currentTime = Date.now();

        var enddatetime = new Date();
        enddatetime.setTime(time + duration * 60 * 1000)

        if (datetime.getTime() < total24hLimit) {
            return '';
        } else {
            var am = parseInt(d.amount);
            var dr = parseInt(d.duration);
            var drunk = d.type === 'breast' ? dr * F : am;
            total24h += drunk;
            if (datetime.getTime() >= total5hLimit) {
                total5h += drunk;
            }
            if (d.type === 'breast') {
                breastD += dr;
                breastA += drunk;
            } else {
                bottleD += dr;
                bottleA += drunk;
            }
        }

        if (lastTimestamp) {
            totalFeedingDiffs += lastTimestamp - time;
        }
        lastTimestamp = time;
        totalFeedings++;

        var datetimeDisplay = formatDate(datetime,true);
        var enddatetimeDisplay = formatDate(enddatetime,false);

        var diff = (currentTime - enddatetime.getTime()) / 1000 / 60; // minutes
        var diffHours = Math.floor(diff / 60)
        var diffDisplay = diffHours.toString().padStart(2,'0') + ':' + (diff - diffHours * 60).toFixed(0).padStart(2,'0');

        var a = d['amount'] !== '0' ?  d.amount + ' ml' : d.duration * F + ' ml';
        return `${datetimeDisplay}-${enddatetimeDisplay} ${t} ${a} üïí ${d['duration'].toString().padStart(2,'0')}‚Ä≤ -${diffDisplay}`
    }).filter(l => !!l.trim().length);

    var avgFeedGap = (totalFeedingDiffs / 1000 / 60 / 60) / totalFeedings;

    document.body.innerHTML = '<pre>'+`${TIMEFRAME}h: ${total24h} ml (${bottleA}üçº+${breastA}ü§±) ${breastD + bottleD} min (${bottleD}üçº+${breastD}ü§±)\n5h: ${total5h} ml / feed every ${avgFeedGap.toFixed(1)}h\n---\n`+display.join('\n')+'</pre>';
}

function formatDate(datetime, short) {
    return datetime.getHours().toString().padStart(2,'0') + ':' + datetime.getMinutes().toString().padStart(2,'0') + (!short ? ' ' + datetime.getDate() + '/' + (datetime.getMonth() + 1) : '');
}

function parser(line) {
    var dict = {};
    line.split(' ').forEach((kv) => {
        var [key, value] = kv.split('=');
        dict[key] = value;
    });
    return dict;
}

getData();


        </script>
    </body>
    </html>


